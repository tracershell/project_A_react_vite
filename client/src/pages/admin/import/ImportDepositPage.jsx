// client/src/pages/admin/import/ImportDepositPage.jsx


import React, { useEffect, useState, useRef } from 'react';
import axios from 'axios';
import styles from './ImportDepositPage.module.css';
import { useLocation, useNavigate } from 'react-router-dom';

const ImportDepositPage = () => {
  const location = useLocation();
  const navigate = useNavigate();

  const [dataSource, setDataSource] = useState('temp');  // 'temp' or 'final'

  // ImportPoPageì—ì„œ ë„˜ì–´ì˜¨ ê°’
  const { rows = [], vendor_id, vendor_name, deposit_rate } = location.state || {};
  const [records, setRecords] = useState([]);
  const [filtered, setFiltered] = useState([]);
  const [dpDate, setDpDate] = useState('');
  const [exRate, setExRate] = useState('');
  const [search, setSearch] = useState({ dp_date: '', style: '', po_no: '' });

  // Extra Pay ì…ë ¥í¼
  const [extraList, setExtraList] = useState([]);
  const [extraForm, setExtraForm] = useState({
    extra_no: '', po_no: '', rate_apply: '', comment: '', amount: ''
  });
  const [autoGeneratedPoNo, setAutoGeneratedPoNo] = useState('');
  const [autoRateApply, setAutoRateApply] = useState('');
  const inputsRef = useRef([]);
  const [comments, setComments] = useState({});
  const [totalRmb, setTotalRmb] = useState(0);
  const [totalUsd, setTotalUsd] = useState(0);


  // 1) ìµœì´ˆ ë§ˆìš´íŠ¸ì‹œ: rows(POì„ íƒ) ìˆìœ¼ë©´ ì„ì‹œí…Œì´ë¸”ì— ì €ì¥, ì•„ë‹ˆë©´ ì„ì‹œí…Œì´ë¸”ë§Œ fetch
  useEffect(() => {
    if (rows.length > 0) {
      setRecords(rows); // ğŸ”´ ì„œë²„ ì €ì¥ X, ìƒíƒœë¡œë§Œ ë³´ê´€
    } else {
      fetchDepositTemp();   // ì´ì „ ì„ì‹œì €ì¥ ê¸°ë¡ì€ DBì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
    }
    fetchExtraList();
  }, []);

  useEffect(() => {
    fetchRecords();   // â† temp ë˜ëŠ” final ë¶ˆëŸ¬ì˜¤ê¸°
    setSearch({ dp_date: '', style: '', po_no: '' });  // ì„ íƒ ì‹œ ê¸°ì¡´ ê²€ìƒ‰ê°’ ì´ˆê¸°í™”
  }, [dataSource]);


  // 1) ì„ì‹œ í…Œì´ë¸”ì—ì„œ ë¦¬ìŠ¤íŠ¸ fetch : ì„ì‹œ or í™•ì • ì €ì¥ ë°ì´íƒ€ ê²€ìƒ‰ ê´€ë ¨
  const [availableDates, setAvailableDates] = useState([]);

  useEffect(() => {
    const fetchDates = async () => {
      try {
        const res = await axios.get('/api/admin/import/deposit/dates');
        setAvailableDates(res.data);  // ['2025-05-22', '2025-05-21', ...]
        console.log('ğŸ“† availableDates:', res.data); // Date ê°’ì´ ì˜ ë“¤ì–´ì˜¤ëŠ” ì§€ - ê²€ìƒ‰ ì•ˆì—ì—
      } catch (err) {
        console.error('âŒ dp_date ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', err);
      }
    };
    if (dataSource === 'final') fetchDates();  // í™•ì •ë°ì´í„° ì„ íƒ ì‹œì—ë§Œ ë¶ˆëŸ¬ì˜¤ê¸°
  }, [dataSource]);


  // 2) ì„ì‹œ í…Œì´ë¸”ì—ì„œ ë¦¬ìŠ¤íŠ¸ fetch
  const fetchDepositTemp = async () => {
    const { data } = await axios.get('/api/admin/import/deposit/temp');
    setRecords(data);
  };

  // 3) Extra ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
  const fetchExtraList = async () => {
    const { data } = await axios.get('/api/admin/import/extra');
    setExtraList(data);
  };


  const fetchRecords = async () => {
    const endpoint =
      dataSource === 'temp'
        ? '/api/admin/import/deposit/temp'
        : '/api/admin/import/deposit/final';
    try {
      const { data } = await axios.get(endpoint, { withCredentials: true });
      setRecords(data);
    } catch (err) {
      console.error('âŒ fetchRecords ì˜¤ë¥˜:', err);
      alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  };


  // 4) Extra ì„ íƒ ì‹œ ìë™ ê°’ ì„¸íŒ…
  useEffect(() => {
    if (!extraForm.extra_no) {
      setAutoRateApply('');
      setExtraForm(f => ({ ...f, po_no: '', rate_apply: '', comment: '', amount: '' }));
      setAutoGeneratedPoNo('');
      return;
    }
    const item = extraList.find(x => x.extra_no === extraForm.extra_no);
    if (item) {
      setAutoRateApply(item.rate_apply || '');
      // âœ… ì‹œ + ë¶„ + ì´ˆ ê¸°ë°˜ ëœë¤ ì½”ë“œ ìƒì„±
      const now = new Date();

      const yy = String(now.getFullYear()).slice(-2); // ë‘ ìë¦¬ ì—°ë„ (ì˜ˆ: "25")
      const MM = String(now.getMonth() + 1).padStart(2, '0'); // ì›” (01~12)
      const dd = String(now.getDate()).padStart(2, '0');      // ì¼ (01~31)
      const hh = String(now.getHours()).padStart(2, '0');     // ì‹œ (00~23)
      const mm = String(now.getMinutes()).padStart(2, '0');   // ë¶„ (00~59)
      const ss = String(now.getSeconds()).padStart(2, '0');   // ì´ˆ (00~59)

      const uniqueCode = `${yy}${MM}${dd}${hh}${mm}${ss}`; // ì˜ˆ: "250525142537"
      const po_no_unique = `${item.po_no || 'EXTRA'}-${uniqueCode}`;

      setAutoGeneratedPoNo(po_no_unique);
      setExtraForm(f => ({
        ...f,
        po_no: po_no_unique,
        rate_apply: item.rate_apply || ''
      }));
    }
  }, [extraForm.extra_no, extraList]);

  const handleExtraChange = e => setExtraForm(f => ({ ...f, [e.target.name]: e.target.value }));

  // 5) Extra Pay Add (ì„ì‹œí…Œì´ë¸”ì— ì €ì¥)
  const handleAddExtra = async () => {
    if (!extraForm.extra_no || !extraForm.po_no || !extraForm.rate_apply || !extraForm.amount) {
      alert('ëª¨ë“  Extra Pay í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”');
      return;
    }

    // í™˜ìœ¨ì ìš©/ë¹„ì ìš© ë¶„ê¸°
    let dp_amount_rmb = '', dp_amount_usd = '', dp_exrate = '';
    let showStyle = extraForm.extra_no;
    if (extraForm.rate_apply === 'í™˜ìœ¨ì ìš©') {
      dp_amount_rmb = Number(extraForm.amount);
      dp_amount_usd = '';
      dp_exrate = '';
    } else {
      dp_amount_rmb = 0;
      dp_amount_usd = Number(extraForm.amount);
      dp_exrate = 1;
    }
    // ì˜¤ëŠ˜ ë‚ ì§œ(YYYY-MM-DD)ë¥¼ po_dateë¡œ ì‚¬ìš©
    const today = new Date();
    const poDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
    const useVendorId = vendor_id || (records[0] && records[0].vendor_id) || '';
    const vendorName = vendor_name || (records[0] && records[0].vendor_name) || '-';
    const vendorRate = deposit_rate || (records[0] && records[0].deposit_rate) || '-';

    try {

      // ğŸ’¡ Extra Pay í•­ëª©ì„ import_po_listì—ë„ ì¶”ê°€
      await axios.post('/api/admin/import/deposit/po/add', {
        vendor_id: useVendorId,
        po_date: poDate,
        style_no: showStyle,
        po_no: extraForm.po_no,
        pcs: 0,
        cost_rmb: 0,
        note: `${extraForm.comment}`
      }, { withCredentials: true });

      // 2. Deposit Pay Listrecordsì—ë§Œ ì¶”ê°€, ì„ì‹œDB ì €ì¥ ì—†ìŒ ğŸ”´
      setRecords(recs => [
        ...recs,
        {
          id: extraForm.po_no,
          vendor_name: vendorName,
          deposit_rate: vendorRate,
          po_no: extraForm.po_no,
          po_date: poDate,
          style_no: showStyle,
          pcs: 0,
          cost_rmb: 0,
          t_amount_rmb: 0,
          dp_amount_rmb,
          dp_amount_usd,
          dp_exrate,
          comment: extraForm.comment,
          isExtra: true
        }
      ]);
      setExtraForm({ extra_no: '', po_no: '', rate_apply: '', comment: '', amount: '' });
      setAutoGeneratedPoNo('');
      alert('Extra Pay ì¶”ê°€ ì™„ë£Œ');
    } catch (err) {
      alert('Extra Pay ì…ë ¥ ì˜¤ë¥˜');
    }
  };

  // ì„ì‹œí…Œì´ë¸” row ì‚­ì œ (ë‘ê°€ì§€ ë¶„ê¸°ë¡œ ì„ì‹œ DB import_temp ì œê±°, import_po_listì—ë„ ì‚­ì œ)
  // âœ… ì„ íƒì œê±° ë²„íŠ¼ í•¸ë“¤ëŸ¬
  const handleRemoveRow = async (row) => {
    const isExtra = row.t_amount_rmb === 0 || row.isExtra === true;

    // ìƒíƒœì—ì„œ ë¨¼ì € ì œê±°
    setRecords(prev => prev.filter(r => r.id !== row.id));

    try {
      // Extra Pay â†’ ì„ì‹œ + ë§ˆìŠ¤í„° ë™ì‹œ ì‚­ì œ
      if (isExtra) {
        await axios.delete(`/api/admin/import/deposit/po/delete/${row.po_no}`, {
          withCredentials: true,
        });
      } else {
        // ì¼ë°˜ â†’ ì„ì‹œë§Œ ì‚­ì œ
        await axios.delete(`/api/admin/import/deposit/temp/delete/${row.id}`, {
          withCredentials: true,
        });
      }
    } catch (err) {
      alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
      console.error('âŒ ì‚­ì œ ì‹¤íŒ¨:', err);
    }
  };


  // ê²€ìƒ‰
  const handleSearch = () => {
    setFiltered(
      records.filter(r => {
        const cleanedDpDate = cleanDate(r.dp_date);
        const matchDpDate = dataSource === 'final'
          ? (!search.dp_date || r.dp_date === search.dp_date)
          : true;  // ì„ì‹œ ë°ì´í„°ëŠ” dp_date í•„í„° ìƒëµ

        const matchStyle = !search.style || r.style_no?.toLowerCase().includes(search.style.toLowerCase());
        const matchPoNo = !search.po_no || r.po_no?.toLowerCase().includes(search.po_no.toLowerCase());

        return matchDpDate && matchStyle && matchPoNo;
      })
    );
  };


  const handleFilteredPdf = async () => {
    try {
      const response = await axios.post(
        '/api/admin/import/deposit/pdf',
        {
          records: filtered.length ? filtered : records,
          date: dpDate,
          exrate: exRate,
        },
        { responseType: 'blob' }
      );
      const pdfUrl = window.URL.createObjectURL(new Blob([response.data], { type: 'application/pdf' }));
      window.open(pdfUrl);
    } catch (err) {
      alert('PDF ìƒì„± ì˜¤ë¥˜');
    }
  };

  useEffect(() => { setFiltered(records); }, [records]);

  // // PayDate, í™˜ìœ¨ ì ìš© (DP Amount(RMB)ê°’ì´ 0ì´ ì•„ë‹ˆë©´ ëª¨ë‘ ìë™ ê³„ì‚°)
  // const applyExRate = () => {
  //   if (!dpDate || !exRate) {
  //     alert('Pay Dateì™€ Exchange Rateë¥¼ ì…ë ¥í•˜ì„¸ìš”');
  //     return;
  //   }
  //   setRecords(recs =>
  //     recs.map(r => {
  //       // ExtraPay(í™˜ìœ¨ë¹„ì ìš©) ìœ ì§€
  //       if ((r.dp_exrate === 1 || r.dp_exrate === "1") && Number(r.dp_amount_rmb) === 0) {
  //         return { ...r, dp_date: dpDate, dp_exrate: 1, dp_amount_usd: r.dp_amount_usd || '' };
  //       }

  //       // ì¼ë°˜ PO (0 ì´ìƒë§Œ ê³„ì‚°)
  //       let dpRmb = Number(r.dp_amount_rmb);
  //       if (!dpRmb) {
  //         // ë§Œì•½ 0ì´ê±°ë‚˜ ê°’ì´ ì—†ìœ¼ë©´ ê³„ì‚°í•´ì„œ ë„£ì–´ì¤Œ
  //         if (r.t_amount_rmb && r.deposit_rate) {
  //           dpRmb = Number(r.t_amount_rmb) * Number(r.deposit_rate) / 100;
  //         } else {
  //           dpRmb = 0;
  //         }
  //       }
  //       return {
  //         ...r,
  //         dp_date: dpDate,
  //         dp_exrate: exRate,
  //         dp_amount_rmb: dpRmb,
  //         dp_amount_usd: (dpRmb && exRate) ? (dpRmb / parseFloat(exRate)).toFixed(2) : '',
  //       };
  //     })
  //   );
  // };

  const applyExRate = async () => {
    if (!dpDate || !exRate) {
      alert('Pay Dateì™€ Exchange Rateë¥¼ ì…ë ¥í•˜ì„¸ìš”');
      return;
    }

    // 1. í™”ë©´ ìƒíƒœ ë¨¼ì € ê³„ì‚°
    const updatedRecords = records.map(r => {
      // ExtraPay(í™˜ìœ¨ë¹„ì ìš©) ìœ ì§€
      if ((r.dp_exrate === 1 || r.dp_exrate === "1") && Number(r.dp_amount_rmb) === 0) {
        return { ...r, dp_date: dpDate, dp_exrate: 1, dp_amount_usd: r.dp_amount_usd || '' };
      }

      // ì¼ë°˜ PO (0 ì´ìƒë§Œ ê³„ì‚°)
      let dpRmb = Number(r.dp_amount_rmb);
      if (!dpRmb) {
        if (r.t_amount_rmb && r.deposit_rate) {
          dpRmb = Number(r.t_amount_rmb) * Number(r.deposit_rate) / 100;
        } else {
          dpRmb = 0;
        }
      }
      return {
        ...r,
        dp_date: cleanDate(dpDate),
        dp_exrate: exRate,
        dp_amount_rmb: dpRmb,
        dp_amount_usd: (dpRmb && exRate) ? (dpRmb / parseFloat(exRate)).toFixed(2) : '',
      };
    });

    // 2. í™”ë©´ì— ë°˜ì˜
    setRecords(updatedRecords);

    // 3. ì„œë²„ì— import_temp ì—…ë°ì´íŠ¸ ìš”ì²­
    try {
      await axios.post('/api/admin/import/deposit/temp/update', {
        rows: updatedRecords
      });
      console.log('[applyExRate] import_temp ì—…ë°ì´íŠ¸ ì™„ë£Œ');
    } catch (err) {
      console.error('[applyExRate] ì„œë²„ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', err);
      alert('í™˜ìœ¨ ì ìš© í›„ ì„œë²„ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  };


  // í•©ê³„ (0ì´ ì•„ë‹Œ ê²ƒë§Œ í•©ê³„ì— í¬í•¨)
  useEffect(() => {
    if (rows.length > 0) {
      const updatedRows = rows.map(r => {
        const t_amount = r.t_amount_rmb || (Number(r.pcs || 0) * Number(r.cost_rmb || 0));
        const rate = Number(r.deposit_rate || deposit_rate || 0);
        let dpAmount = r.dp_amount_rmb;
        if (dpAmount === undefined || dpAmount === null || dpAmount === '') {
          dpAmount = (t_amount * rate / 100).toFixed(2);
        }
        return {
          ...r,
          t_amount_rmb: t_amount,
          dp_amount_rmb: dpAmount
        };
      });
      setRecords(updatedRows);
    } else {
      fetchDepositTemp();
    }
    fetchExtraList();
  }, []);

  // table í•©ê³„ ê³„ì‚°

  useEffect(() => {
    let totalRmb = 0, totalUsd = 0;
    for (const r of records) {
      // í…Œì´ë¸”ê³¼ ë™ì¼ ê³µì‹ìœ¼ë¡œ ì¦‰ì„ ê³„ì‚°
      const t_amount_rmb = r.t_amount_rmb || (Number(r.pcs || 0) * Number(r.cost_rmb || 0));
      const rate =
        r.deposit_rate !== undefined && r.deposit_rate !== null && r.deposit_rate !== ''
          ? Number(r.deposit_rate)
          : Number(deposit_rate) || 0;
      const dp_amount_rmb = (t_amount_rmb * rate / 100);
      if (!isNaN(dp_amount_rmb)) totalRmb += dp_amount_rmb;

      if (!isNaN(parseFloat(r.dp_amount_usd))) totalUsd += parseFloat(r.dp_amount_usd) || 0;
    }
    setTotalRmb(totalRmb);
    setTotalUsd(totalUsd);
  }, [records]);

  // í˜ì´ì§€ ì–¸ë§ˆìš´íŠ¸ ì‹œ ì„ì‹œ í…Œì´ë¸” ì‚­ì œ
  useEffect(() => {
    return () => {
      axios.delete('/api/admin/import/deposit/temp/clear').catch(() => { });
    };
  }, []);

  // formatDate í•¨ìˆ˜ ìˆ˜ì •
  const formatDate = (value) => {
    if (!value) return '';
    if (typeof value === 'string' && value.includes('-')) return value;
    const date = new Date(value);
    const offset = date.getTimezoneOffset();
    const localDate = new Date(date.getTime() - offset * 60000);
    return localDate.toISOString().split('T')[0];
  };


  // ë‚ ì§œ í¬ë§· ì •ë¦¬ : í˜•ì‹ ë³€í™˜ í•¨ìˆ˜ MYWQL DATE YYYY-MM-DD
  // ìˆ˜ì • (ğŸš€ ì„œë²„ì—ì„œ ë¬¸ìì—´ë¡œ ì˜¤ë¯€ë¡œ ê·¸ëŒ€ë¡œ ë°˜í™˜)
  const cleanDate = (dateStr) => {
    if (!dateStr) return null;
    if (typeof dateStr === 'string' && dateStr.includes('-')) return dateStr;
    const date = new Date(dateStr);
    return date.toISOString().split('T')[0];
  };


  // Pay: ì„ì‹œí…Œì´ë¸” â†’ ì‹¤í…Œì´ë¸” ì»¤ë°‹
  const handlePay = async () => {
    if (!dpDate || !exRate) return alert('DP Date/Exchange Rateë¥¼ ì…ë ¥í•˜ì„¸ìš”');
    try {
      // ğŸ”¸ ë‚ ì§œ ë° ê¸°íƒ€ í¬ë§· ì •ë¦¬
      const cleanedRecords = records.map(r => ({
        ...r,
        po_date: cleanDate(r.po_date),
        dp_date: cleanDate(dpDate),
        dp_exrate: r.dp_exrate || exRate || 1,          // ê¸°ë³¸ 1 ë³´ì™„
        dp_amount_rmb: r.dp_amount_rmb ?? 0,             // undefined/null ë°©ì§€
        vendor_id: r.vendor_id || vendor_id,            // âœ… ê¸°ë³¸ê°’ ë³´ì™„
        vendor_name: r.vendor_name || vendor_name,      // âœ… ê¸°ë³¸ê°’ ë³´ì™„
        deposit_rate: r.deposit_rate || deposit_rate
      }));

      console.log('ğŸ“¦ [DEBUG] cleanedRecords:', cleanedRecords);

      // 1. ì„ì‹œ ì €ì¥
      await axios.post(
        '/api/admin/import/deposit/batchAdd',
        { rows: cleanedRecords, vendor_id, vendor_name, deposit_rate },
        { withCredentials: true }
      );

      // 2. ì»¤ë°‹
      await axios.post(
        '/api/admin/import/deposit/temp/commit',   // â† ë¡œì§ì€ ë™ì¼, ë°±ì—”ë“œê°€ import_temp ì½ë„ë¡ ìˆ˜ì •
        { dp_date: cleanDate(dpDate), dp_exrate: exRate },
        { withCredentials: true }
      );

      alert('ì •ìƒì ìœ¼ë¡œ ì €ì¥(ì»¤ë°‹) ì™„ë£Œ!');
      navigate('/admin/import/po');
    } catch (err) {
      console.error('âŒ ì €ì¥ ì¤‘ ì˜¤ë¥˜:', err);
      alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜: ' + (err.response?.data?.error || err.message));
    }
  };

  const handleViewPdf = async () => {
    // í˜„ì¬ Deposit Pay List(ExtraPay/ì„ì‹œí¬í•¨) ì „ì²´ë¥¼ PDFë¡œ ì¶œë ¥
    try {
      const response = await axios.post(
        '/api/admin/import/deposit/pdf',
        {
          records,  // í˜„ì¬ í™”ë©´ì˜ ëª¨ë“  rows
          date: dpDate,
          exrate: exRate,
        },
        { responseType: 'blob' } // PDF íŒŒì¼ ë‹¤ìš´ë¡œë“œìš©
      );
      // Blob URLë¡œ ìƒˆ ì°½ì— ë„ì›€
      const pdfUrl = window.URL.createObjectURL(new Blob([response.data], { type: 'application/pdf' }));
      window.open(pdfUrl);
    } catch (err) {
      alert('PDF ìƒì„± ì˜¤ë¥˜');
    }
  };

  const handleCommentChange = (id, val) => {
    setComments(c => ({ ...c, [id]: val }));
  };
  // â”€â”€ DP Amount í•©ê³„ ê³„ì‚° login
  const dataRows = filtered.length
  ? filtered.filter(r => r.selected)
  : records.filter(r => r.selected);
  const sumDpRmb = dataRows.reduce((sum, r) => {
    const dp = (r.dp_amount_rmb !== undefined && r.dp_amount_rmb !== null && r.dp_amount_rmb !== '')
      ? Number(r.dp_amount_rmb)
      : (Number(r.pcs || 0) * Number(r.cost_rmb || 0) * (Number(r.deposit_rate || deposit_rate) / 100));
    return sum + (isNaN(dp) ? 0 : dp);
  }, 0);
  const sumDpUsd = dataRows.reduce((sum, r) => {
    const u = parseFloat(r.dp_amount_usd);
    return sum + (isNaN(u) ? 0 : u);
  }, 0);


  // --- TABLE HEADER & BODY êµ¬ì„±: ì²¨ë¶€ ì´ë¯¸ì§€ì™€ ìš”êµ¬ì— ë§ê²Œ ---
  return (
    <div className={styles.page}>
      <h2>Extra Pay Input</h2>
      <div className={`${styles.formRow} ${styles.small}`}>
        <select name="extra_no" value={extraForm.extra_no} onChange={handleExtraChange}>
          <option value="">ì„ íƒ: Extra no.</option>
          {extraList.map(x => (
            <option key={x.id} value={x.extra_no}>{x.extra_no}</option>
          ))}
        </select>
        <input name="po_no" placeholder="Extra PO no." value={autoGeneratedPoNo} readOnly />
        <select name="rate_apply" value={autoRateApply || extraForm.rate_apply} onChange={handleExtraChange} readOnly>
          <option value="">ì„ íƒ</option>
          <option value="í™˜ìœ¨ì ìš©">í™˜ìœ¨ì ìš©</option>
          <option value="í™˜ìœ¨ë¹„ì ìš©">í™˜ìœ¨ë¹„ì ìš©</option>
        </select>
        <input name="comment" placeholder="Comment" value={extraForm.comment} onChange={handleExtraChange} />
        <input type="number" name="amount" placeholder="Extra Amount" value={extraForm.amount} onChange={handleExtraChange} />
        <button type="button" onClick={handleAddExtra}>Extra Pay Add</button>
      </div>

      <h2>Deposit Pay List</h2>
      <div className={styles.formRowGroup}>
        {/* âœ… [ì¶”ê°€ ìœ„ì¹˜] ì¡°íšŒ ëŒ€ìƒ ì„ íƒ ì½¤ë³´ë°•ìŠ¤ */}
        <div className={`${styles.formRow} ${styles.small}`}>
          <label style={{ fontWeight: 'bold', marginRight: '8px' }}>ì¡°íšŒ ëŒ€ìƒ:</label>
          <select value={dataSource} onChange={e => setDataSource(e.target.value)}>
            <option value="temp">ì„ì‹œ ë°ì´í„°</option>
            <option value="final">í™•ì • ë°ì´í„°</option>
          </select>

          {/* âœ… [ì¶”ê°€ëœ ìë™ ë‚ ì§œ í•„í„° select] */}
          {dataSource === 'final' && (
            <select
              value={search.dp_date}
              onChange={e => {
                const val = e.target.value;

                if (!val) {
                  setSearch({ dp_date: '', style: '', po_no: '' });
                  setFiltered(records);
                  return;
                }

                // âœ… ìµœì‹  search ìƒíƒœë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•„í„°ë§
                const updatedSearch = { ...search, dp_date: val };
                setSearch(updatedSearch);

                const newFiltered = records.filter(r => {
                  return (
                    cleanDate(r.dp_date) === val &&
                    (!updatedSearch.style || r.style_no?.toLowerCase().includes(updatedSearch.style.toLowerCase())) &&
                    (!updatedSearch.po_no || r.po_no?.toLowerCase().includes(updatedSearch.po_no.toLowerCase()))
                  );
                });

                setFiltered(newFiltered);
              }}
            >
              <option value="">:: ì „ì²´ ë‚ ì§œ ë³´ê¸° ::</option>
              {availableDates.map(d => (
                <option key={d} value={cleanDate(d)}>
                  {cleanDate(d)}
                </option>
              ))}
            </select>

          )}


          <input
            placeholder="Style"
            value={search.style}
            onChange={e => {
              const newVal = e.target.value;
              const updated = { ...search, style: newVal };
              setSearch(updated);
              // í•„í„° ì ìš©
              setFiltered(records.filter(r =>
                (!updated.dp_date || cleanDate(r.dp_date) === updated.dp_date) &&
                (!updated.style || r.style_no?.toLowerCase().includes(updated.style.toLowerCase())) &&
                (!updated.po_no || r.po_no?.toLowerCase().includes(updated.po_no.toLowerCase()))
              ));
            }}
          />
          <input
            placeholder="PO no."
            value={search.po_no}
            onChange={e => {
              const newVal = e.target.value;
              const updated = { ...search, po_no: newVal };
              setSearch(updated);
              // í•„í„° ì ìš©
              setFiltered(records.filter(r =>
                (!updated.dp_date || cleanDate(r.dp_date) === updated.dp_date) &&
                (!updated.style || r.style_no?.toLowerCase().includes(updated.style.toLowerCase())) &&
                (!updated.po_no || r.po_no?.toLowerCase().includes(updated.po_no.toLowerCase()))
              ));
            }}
          />
          <button type="button" onClick={handleSearch}>ê²€ìƒ‰</button>
          <button type="button" onClick={handleFilteredPdf}>PDF ë³´ê¸°</button>
        </div>

        {/* 2) Pay Date / Exchange Rate / ë²„íŠ¼ ì˜ì—­ */}
        {/* Pay Date / Exchange Rate / ë²„íŠ¼ ì˜ì—­ */}
        <div className={`${styles.formRow} ${styles.small}`} style={{ marginTop: '4px' }}>
          <span style={{ fontWeight: 'bold' }}>Pay Date</span>
          <input
            type="date"
            value={dpDate}
            onChange={e => setDpDate(e.target.value)}
            style={{ minWidth: '8rem' }}
          />
          <span style={{ marginLeft: '1rem', fontWeight: 'bold' }}>Exchange Rate</span>
          <input
            type="number"
            step="0.0001"
            value={exRate}
            onChange={e => setExRate(e.target.value)}
            style={{ minWidth: '6rem' }}
          />
          <button
            type="button"
            onClick={applyExRate}
            disabled={dataSource === 'final'}
          >
            í™˜ìœ¨ì ìš©
          </button>
          <button
            type="button"
            onClick={handleViewPdf}
            disabled={dataSource === 'final'}
          >
            PDF ë³´ê¸°
          </button>
          <button
            type="button"
            onClick={handlePay}
            disabled={dataSource === 'final'}
          >
            Pay
          </button>
        </div>



      </div>
      {/* Deposit Pay Table */}
      <div className={styles.page} style={{ overflowX: 'auto' }}>
        <table className={styles.compactTable}>
          <thead>
            <tr>
              <th>ì„ íƒì œê±°</th>
              <th>Vendor Name</th>
              <th>Vendor Rate</th>
              <th>PO Date</th>
              <th>Style</th>
              <th>PO No.</th>
              <th>pcs</th>
              <th>cost(RMB)</th>
              <th>T.Amount(RMB)</th>
              <th>DP Amount(RMB)</th>
              <th>DP Date</th>
              <th>DP E.rate</th>
              <th>DP Amount(USD)</th>
              <th>Comment</th>
            </tr>
          </thead>
          <tbody>
            {(filtered.length ? filtered : records).map(r => (
              <tr key={r.id}>
                <td>
                  <button
                    type="button"
                    onClick={() => handleRemoveRow(r)}
                    disabled={dataSource === 'final'}  // í™•ì • ë°ì´í„°ë©´ ë¹„í™œì„±í™”
                  >
                    ì„ íƒì œê±°
                  </button>
                </td>
                <td>{r.vendor_name}</td>
                <td>{r.deposit_rate || ''}</td>
                <td>{formatDate(r.po_date)}</td>
                <td>{r.style_no}</td>
                <td>{r.po_no}</td>
                <td>{r.pcs != null ? Number(r.pcs).toLocaleString() : ''}</td>
                <td>{r.cost_rmb}</td>
                <td>{
                  r.pcs && r.cost_rmb
                    ? (Number(r.pcs) * Number(r.cost_rmb))
                      .toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })
                    : ''
                }</td>
                <td>
                  {(() => {
                    const t_amount_rmb = r.t_amount_rmb || (Number(r.pcs || 0) * Number(r.cost_rmb || 0));
                    const rmbVal = (r.dp_amount_rmb !== undefined && r.dp_amount_rmb !== null && r.dp_amount_rmb !== '' && Number(r.dp_amount_rmb) !== 0)
                      ? Number(r.dp_amount_rmb)
                      : (t_amount_rmb * (Number(r.deposit_rate) / 100));
                    return rmbVal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                  })()}
                </td>

                <td>{formatDate(r.dp_date)}</td>
                <td>{r.dp_exrate || ''}</td>
                <td>{
                  r.dp_amount_usd
                    ? Number(r.dp_amount_usd)
                      .toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })
                    : ''
                }</td>
                <td>
                  {comments[r.id] ?? r.comment ?? ''}
                </td>
              </tr>
            ))}
          </tbody>
          <tfoot>
            <tr>
              {/* DP Amount(RMB) ì™€ DP Amount(USD) ë§Œ í•©ê³„ */}
              <td colSpan={9} style={{ textAlign: 'right', fontWeight: 'bold' }}>í•©ê³„</td>
              <td style={{ fontWeight: 'bold', color: 'darkred' }}>
                {sumDpRmb.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
              </td>
              {/* DP Date, DP E.rate ë¹ˆ ì¹¸ */}
              <td></td>
              <td></td>
              <td style={{ fontWeight: 'bold', color: 'darkred' }}>
                {sumDpUsd.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
              </td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div >
  );
};

export default ImportDepositPage;